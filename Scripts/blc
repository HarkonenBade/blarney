#! /usr/bin/env bash

if [ -z "$BLARNEY_ROOT" ]; then
  echo "Please set BLARNEY_ROOT"
  exit 1
fi

# Default options
EnableNamerPlugin=No

# Override defaults using config file, if available
if [ -f "$BLARNEY_CONF" ]; then
  source "$BLARNEY_CONF"
elif [ -f "$BLARNEY_ROOT/blarney.conf" ]; then
  source "$BLARNEY_ROOT/blarney.conf"
fi

# Extract command-line flags/arguments
POSITIONAL=()
while [[ $# -gt 0 ]]; do
  key="$1"
  case $key in
    --enable-namer-plugin)
    EnableNamerPlugin=Yes
    shift # past argument
    ;;
    --disable-namer-plugin)
    EnableNamerPlugin=No
    shift # past argument
    ;;
    *)
    POSITIONAL+=("$1") # save it in an array for later
    shift # past argument
    ;;
  esac
done
set -- "${POSITIONAL[@]}" # restore positional parameters

if [ -z "$1" ]; then
  echo "Usage: blc [FLAGS] [FILE].hs"
  echo "Supported flags:"
  echo "  --enable-namer-plugin              Enable Namer plugin"
  echo "  --disable-namer-plugin             Disable Namer plugin"
  exit 1
fi

GHC="ghc --make"
OPT="-O"
if [ `basename $0` == "blci" ]; then
  GHC="ghci"
  OPT=""
fi

EXTS="-XScopedTypeVariables -XDataKinds -XTypeOperators -XTypeFamilies"
EXTS="$EXTS -XBinaryLiterals -XNoImplicitPrelude -XFlexibleContexts"
EXTS="$EXTS -XRebindableSyntax -XPartialTypeSignatures -XDeriveGeneric"
EXTS="$EXTS -XDeriveAnyClass -XRecursiveDo -XBlockArguments"
EXTS="$EXTS -XNumericUnderscores -XTypeApplications"
EXTS="$EXTS -XDuplicateRecordFields"
EXTS="$EXTS -XNoStarIsType"
WARN="-Wno-partial-type-signatures"
FLAGS="-fno-cse -fno-full-laziness"
if [ "$EnableNamerPlugin" = "Yes" ]; then
  FLAGS="$FLAGS -package blarney-plugins-namer -fplugin=BlarneyPlugins.Namer"
fi
INC="$BLARNEY_ROOT/Haskell"
INC_H="$BLARNEY_ROOT/Haskell/Blarney/:./"

$GHC $OPT $FLAGS $WARN -cpp -I$INC_H $EXTS -i$INC $@
